#!/bin/bash
{%- from "./cliopts.j2" import cliopts %}

# Training script for h001
set -e

# Move to git root
export PBS_O_WORKDIR=$(git rev-parse --show-toplevel)
cd ${PBS_O_WORKDIR}

# MPI and OpenMP settings
NNODES=1
NRANKS_PER_NODE=2
NDEPTH=128
NTOTRANKS=$((NNODES * NRANKS_PER_NODE))
echo "NUM_OF_NODES= ${NNODES} TOTAL_NUM_RANKS= ${NTOTRANKS} RANKS_PER_NODE= ${NRANKS_PER_NODE}"

# Activate Environment
spack env activate .
source activate

{%- if nsys is defined %}
nsys profile \
      {{- cliopts( nsys ) | indent }} \
{%- endif %}
mpiexec \
    {{- cliopts( mpiexe ) | indent }} \
    python3 train.py fit \
    {{- cliopts( train ) | indent }}
