#!/bin/bash
{%- from "./utils.j2" import cliopts, export_env %}
#SBATCH -p venkvis-debug
#SBATCH --nodes {{ nodes or 1 }}
#SBATCH --ntasks-per-node {{ gpus_per_node or 2 }}
#SBATCH --gpus-per-node {{ gpus_per_node or 2 }}
#SBATCH --time {{ walltime or "0:30:00" }}
#SBATCH --cpus-per-task 48
#SBATCH --mem-per-cpu 2G

# Training script for h001
my_job_header
set -e

# Move to git root
cd $(git rev-parse --show-toplevel)

# MPI and OpenMP settings
export NRANKS=1

# Activate Environment
module purge
module --ignore_cache load spack/0.21 python/3.11.5 cuda/12.2 openmpi/4.1.6
source ./activate

# Set env variables
{{- export_env( env ) }}

{%- if nsys is defined %}
nsys profile \
      {{- cliopts( nsys ) | indent }} \
{%- endif %}
srun \
    python3 train.py fit \
    {{- cliopts( train ) | indent }}
